<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operator Panel - Face Segregation</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/lucide.min.js"></script>
</head>
<body class="operator-page">
    <div class="container operator-container">
        <header class="header operator-header">
            <div class="header-content">
                <h1>SortFace</h1>
                <p class="subtitle">Command Center</p>
            </div>
            
            <label class="theme-switch" aria-label="Toggle Dark Mode">
                <input type="checkbox" id="theme-checkbox" onchange="toggleTheme()">
                <span class="slider round"></span>
            </label>
        </header>
        
        <main class="operator-grid">
            <!-- 1. Job Config -->
            <section class="panel" id="job-config-card">
                <h2><i data-lucide="settings" class="icon"></i>Job Configuration</h2>
                <div class="job-config-summary job-config-fill">
                    <div class="job-config-block job-config-block-large">
                        <div class="job-config-icon-label">
                            <i data-lucide="folder-open" class="icon icon-lg config-icon"></i>
                            <span class="job-config-label-large">Source</span>
                        </div>
                        <div class="job-config-value-row">
                            <span id="job-config-source" class="job-config-path job-config-path-large">—</span>
                            <button type="button" class="btn btn-small btn-icon-only" onclick="openJobConfigModal()"><i data-lucide="pencil" class="icon icon-sm"></i></button>
                        </div>
                    </div>
                    <div class="job-config-block job-config-block-large">
                        <div class="job-config-icon-label">
                            <i data-lucide="folder-check" class="icon icon-lg config-icon"></i>
                            <span class="job-config-label-large">Output</span>
                        </div>
                        <div class="job-config-value-row">
                            <span id="job-config-output" class="job-config-path job-config-path-large">—</span>
                            <button type="button" class="btn btn-small btn-icon-only" onclick="openJobConfigModal()"><i data-lucide="pencil" class="icon icon-sm"></i></button>
                        </div>
                    </div>
                </div>
                <div id="job-config-card-status" class="status-message"></div>
            </section>

            <!-- 2. Search For -->
            <section class="panel" id="job-control-panel">
                <h2><i data-lucide="search" class="icon"></i>Search For</h2>
                <div class="search-for-fill">
                    <div class="search-for-block">
                        <div class="search-for-icon-label">
                            <i data-lucide="users" class="icon icon-lg config-icon"></i>
                            <span class="search-for-label-large">People</span>
                        </div>
                        <!-- Thumbnail Preview Row -->
                        <div id="selected-people-thumbnails" class="selected-thumbnails-row">
                            <!-- Populated dynamically by JS -->
                        </div>
                        <div class="search-for-value-row">
                            <span id="person-selection-summary" class="search-for-summary-large">—</span>
                            <button type="button" class="btn btn-small" onclick="openPersonSelectionModal()"><i data-lucide="edit" class="icon icon-sm"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Job Status -->
            <section class="panel" id="job-status-panel">
                <h2><i data-lucide="activity" class="icon"></i>Job Status</h2>
                
                <div class="job-status-content-v2 dense-layout">
                    <div id="job-status-split-zone" class="status-split-zone">
                        <!-- Left Zone: Status Info -->
                        <div class="status-info-zone">
                            <div class="status-badge-apple idle" id="job-status-badge">
                                <span class="dot"></span>
                                <span id="status-label">Idle</span>
                            </div>
                            <div id="job-status-message-v2" class="status-message-v2">Ready to process images</div>
                        </div>

                        <!-- Right Zone: Primary Actions -->
                        <div class="status-actions-zone">
                            <button id="btn-job-action" class="btn btn-pill-apple primary" onclick="handleJobActionMain()" disabled>
                                <i data-lucide="play" class="icon icon-sm"></i>
                                <span>Start Job</span>
                            </button>
                            <button id="btn-job-terminate-mini" class="btn-icon-subtle" onclick="terminateJob()" disabled title="Terminate immediately">
                                <i data-lucide="x-circle" class="icon"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Integrated Footer for Worker Status -->
                    <div class="worker-status-banner">
                        <div class="worker-connection">
                            <div id="worker-dot-v2" class="connection-dot offline"></div>
                            <span id="worker-text-v2">Worker Offline</span>
                        </div>
                        <p id="worker-hint-v2" class="worker-hint-mini">Run <code>python scripts/run_worker.py</code></p>
                    </div>
                </div>
            </section>

            <!-- 4. Job Progress -->
            <section class="panel" id="job-progress-panel">
                <h2><i data-lucide="bar-chart-2" class="icon"></i>Job Progress</h2>
                
                <!-- Initial state message (shown before first batch) -->
                <div id="progress-initializing" class="progress-initializing" style="display: none;">
                    <div class="initializing-icon">
                        <i data-lucide="loader-2" class="icon icon-lg spin"></i>
                    </div>
                    <div class="initializing-text">
                        <span class="initializing-title">Preparing...</span>
                        <span class="initializing-detail">Discovering images and initializing first batch</span>
                    </div>
                </div>
                
                <div id="progress-section" class="progress-section" style="display: none;">
                    <!-- Stats Dashboard Grid -->
                    <div class="progress-stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-images-done">0</div>
                            <div class="stat-label">Images Done</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value stat-speed" id="stat-speed">0.00</div>
                            <div class="stat-label">img/s Speed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value stat-percent" id="stat-percent">0%</div>
                            <div class="stat-label">Complete</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-elapsed">—</div>
                            <div class="stat-label">Elapsed</div>
                        </div>
                    </div>
                    
                    <!-- Speed Graph - Apple-style green gradient -->
                    <div id="speed-graph-container" class="speed-graph-container" style="display:none; width: 100%; height: 60px; margin: 0.75rem 0;">
                        <svg width="100%" height="100%" viewBox="0 0 300 60" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="speedGradient" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#34C759" stop-opacity="0.5"/>
                                    <stop offset="50%" stop-color="#30D158" stop-opacity="0.25"/>
                                    <stop offset="100%" stop-color="#32D74B" stop-opacity="0.05"/>
                                </linearGradient>
                            </defs>
                            <path id="speed-graph-area" fill="url(#speedGradient)" d=""></path>
                            <path id="speed-graph-line" fill="none" stroke="#34C759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d=""></path>
                        </svg>
                    </div>

                    <!-- Progress Bar -->
                    <div id="progress-display" class="progress-display">
                        <div class="progress-bar-wrap"><div id="progress-bar" class="progress-bar" style="width: 0%;"></div></div>
                        <div id="progress-text" class="progress-text">—</div>
                    </div>
                    
                    <!-- Hidden legacy elements for JS compatibility -->
                    <div id="progress-source-line" style="display:none;"></div>
                    <div id="progress-current-image" style="display:none;"></div>
                    <div id="progress-speed" style="display:none;"></div>
                    <div id="progress-time" style="display:none;"></div>
                </div>

                <!-- Results Summary (shown when data available) -->
                <div id="results-summary-section" class="results-summary-section" style="display: none;">
                    <button type="button" class="results-toggle" onclick="toggleResultsPanel()">
                        <i data-lucide="bar-chart-3" class="icon icon-sm"></i>
                        <span>Results Breakdown</span>
                        <i data-lucide="chevron-down" class="icon icon-sm results-chevron" id="results-chevron"></i>
                    </button>
                    <div id="results-summary-body" class="results-summary-body" style="display: none;">
                        <table class="results-summary-table">
                            <thead>
                                <tr>
                                    <th>Person</th>
                                    <th>Folder</th>
                                    <th class="num">Photos</th>
                                </tr>
                            </thead>
                            <tbody id="results-summary-tbody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- No job message -->
                <div id="progress-empty" class="progress-empty">
                    <p>No active job. Configure source/output directories and start a job.</p>
                </div>
            </section>
            
            <!-- 5. Person Registry -->
            <section class="panel person-registry-card" id="person-registry-card">
                <div class="registry-split-layout">
                    <!-- Left Sidebar: Info & Search -->
                    <div class="registry-sidebar">
                        <div class="registry-sidebar-header">
                            <h2><i data-lucide="users" class="icon"></i>Registry</h2>
                            <div class="registry-count-badge" id="registry-count-badge">0 People</div>
                        </div>
                        
                        <div class="registry-search-box">
                            <i data-lucide="search" class="icon icon-sm"></i>
                            <input type="text" id="registry-search-input" placeholder="Search people..." onkeyup="filterRegistry()">
                        </div>

                        <div class="registry-sidebar-actions">
                            <button class="btn btn-subtle-apple btn-sm" onclick="openPersonRegistryModal('add')">
                                <i data-lucide="user-plus" class="icon icon-sm"></i>
                                <span>Add New Person</span>
                            </button>
                        </div>
                    </div>

                    <!-- Right Main: Grid -->
                    <div class="registry-main-grid-wrapper" onclick="openPersonRegistryModal('list')">
                        <div id="registry-thumb-grid" class="registry-thumb-grid">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Job Config Modal -->
    <div id="job-config-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i data-lucide="settings" class="icon"></i>Job Configuration</h3>
                <button class="modal-close" onclick="closeJobConfigModal()"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="modal-body">
                <form id="job-config-form" class="form">
                    <div class="form-group">
                        <label for="source-root">Source Directory (External HDD - Read Only)</label>
                        <div class="input-with-button">
                            <input type="text" id="source-root" name="source_root" placeholder="E:\EventPhotos\Raw" required>
                            <button type="button" class="btn btn-browse" onclick="openFolderBrowser('source-root')"><i data-lucide="folder-open" class="icon icon-sm"></i>Browse</button>
                        </div>
                        <small>Path to folder containing event photos (.jpg, .jpeg, .arw)</small>
                    </div>
                    <div class="form-group">
                        <label for="output-root">Output Directory (External HDD - Append Only)</label>
                        <div class="input-with-button">
                            <input type="text" id="output-root" name="output_root" placeholder="E:\EventPhotos\Sorted" required>
                            <button type="button" class="btn btn-browse" onclick="openFolderBrowser('output-root')"><i data-lucide="folder-open" class="icon icon-sm"></i>Browse</button>
                        </div>
                        <small>Base path where person folders will be created</small>
                    </div>
                </form>
                <div id="job-config-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button type="submit" form="job-config-form" class="btn btn-primary"><i data-lucide="check" class="icon icon-sm"></i>Save</button>
            </div>
        </div>
    </div>

    <!-- Person Selection Modal -->
    <div id="person-selection-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i data-lucide="search" class="icon"></i>Search For</h3>
                <button class="modal-close" onclick="closePersonSelectionModal()"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="modal-body">
                <p class="selection-hint">Select which persons to search for in this job:</p>
                <div class="selection-buttons">
                    <button type="button" class="btn btn-small" onclick="selectAllPersons()">Select All</button>
                    <button type="button" class="btn btn-small" onclick="selectNoPersons()">Select None</button>
                    <span class="selection-divider">|</span>
                    <button type="button" class="btn btn-small" id="btn-group-mode" onclick="toggleGroupMode()">
                        <i data-lucide="users" class="icon icon-sm"></i>Select Group
                    </button>
                </div>
                
                <!-- Group Mode Configuration (hidden by default) -->
                <div id="group-mode-config" class="group-mode-config" style="display: none;">
                    <div class="group-mode-hint">
                        <i data-lucide="info" class="icon icon-sm"></i>
                        <span><strong>Group Mode:</strong> Only photos containing <em>ALL</em> selected people will be saved to a single folder.</span>
                    </div>
                    <div class="form-group">
                        <label for="group-folder-name">Group Folder Name</label>
                        <input type="text" id="group-folder-name" placeholder="e.g., Family_Photos or John_and_Jane" />
                        <small>Photos with all selected people will be saved here</small>
                    </div>
                </div>
                
                <div id="person-selection-list" class="person-selection-list">
                    <p class="loading">Loading persons...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closePersonSelectionModal()"><i data-lucide="x" class="icon icon-sm"></i>Close</button>
                <button class="btn btn-primary" onclick="applyPersonSelection()"><i data-lucide="check" class="icon icon-sm"></i>Apply</button>
            </div>
        </div>
    </div>

    <!-- Person Registry Modal (tabs: Add Person | Registered Persons) -->
    <div id="person-registry-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i data-lucide="users" class="icon"></i>Person Registry</h3>
                <button class="modal-close" onclick="closePersonRegistryModal()"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="add" onclick="switchPersonRegistryTab('add')"><i data-lucide="user-plus" class="icon icon-sm"></i>Add Person</button>
                <button type="button" class="modal-tab" data-tab="list" onclick="switchPersonRegistryTab('list')"><i data-lucide="list" class="icon icon-sm"></i>Registered Persons</button>
            </div>
            <div class="modal-body">
                <div id="person-registry-tab-add" class="modal-tab-pane active">
                    <p class="panel-description">Add reference photos to seed person identities. Each reference must contain exactly one face.</p>
                    <form id="seed-person-form" class="form" enctype="multipart/form-data">
                        <div class="form-row form-row-2">
                            <div class="form-group">
                                <label for="person-name">Person Name</label>
                                <input type="text" id="person-name" name="name" placeholder="John Smith" required>
                            </div>
                            <div class="form-group">
                                <label for="folder-name">Output Folder Name</label>
                                <input type="text" id="folder-name" name="folder_name" placeholder="john_smith" required>
                                <small>Folder name under output directory (no spaces recommended)</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reference-image">Reference Images (select multiple)</label>
                            <input type="file" id="reference-image" name="reference_image" accept=".jpg,.jpeg,.png" multiple required>
                            <small>Each photo must have exactly ONE face. Select multiple with Ctrl+Click.</small>
                        </div>
                    </form>
                    <div id="seed-person-status" class="status-message"></div>
                </div>
                <div id="person-registry-tab-list" class="modal-tab-pane" style="display: none;">
                    <div class="registry-list">
                        <div id="persons-list" class="persons-grid">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closePersonRegistryModal()"><i data-lucide="x" class="icon icon-sm"></i>Close</button>
                <button id="btn-submit-seed" type="submit" form="seed-person-form" class="btn btn-primary"><i data-lucide="user-plus" class="icon icon-sm"></i>Add Person</button>
            </div>
        </div>
    </div>

    <!-- Person Details Modal (opened when clicking a person in Registered Persons) -->
    <div id="person-details-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="person-details-name">—</h3>
                <button class="modal-close" onclick="closePersonDetailsModal()"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="modal-body">
                <p class="person-details-row"><span class="label">Output folder:</span> <span id="person-details-folder" class="value">—</span></p>
                <p class="person-details-row"><span class="label">References:</span> <span id="person-details-embeddings" class="value">—</span></p>
                <div class="add-ref-section">
                    <label class="add-ref-label" for="person-details-ref-input"><i data-lucide="plus" class="icon icon-sm"></i> Add more references (select multiple)</label>
                    <input type="file" id="person-details-ref-input" class="add-ref-input" accept=".jpg,.jpeg,.png" multiple onchange="onPersonDetailsAddRef(this)">
                </div>
                <div class="person-details-delete">
                    <button type="button" class="btn btn-danger" onclick="deletePersonFromDetailsFromModal()"><i data-lucide="trash-2" class="icon icon-sm"></i>Delete Person</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folder-browser-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i data-lucide="folder" class="icon"></i>Select Folder</h3>
                <button class="modal-close" onclick="closeFolderBrowser()"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="modal-body">
                <div class="folder-nav-bar">
                    <button class="btn btn-nav" onclick="loadFolders(null)" title="Show all drives"><i data-lucide="hard-drive" class="icon icon-sm"></i>Drives</button>
                    <button class="btn btn-nav" onclick="navigateToParent()" id="btn-parent" title="Go up one level"><i data-lucide="arrow-up" class="icon icon-sm"></i>Up</button>
                </div>
                <div class="folder-path-display">
                    <span class="path-label">Current:</span>
                    <span id="current-path" class="current-path">Select a drive...</span>
                </div>
                <div id="folder-list" class="folder-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeFolderBrowser()"><i data-lucide="x" class="icon icon-sm"></i>Cancel</button>
                <button class="btn btn-primary" onclick="selectCurrentFolder()"><i data-lucide="check" class="icon icon-sm"></i>Select This Folder</button>
            </div>
        </div>
    </div>
    
    <script src="/static/js/anime.min.js"></script>
    <script src="/static/js/animations.js"></script>
    <script src="/static/js/operator.js"></script>
    <script>
        lucide.createIcons();
        document.addEventListener('DOMContentLoaded', () => {
            // Animate panels on load
            Animations.pageLoad('.operator-header, .operator-cell .panel', {
                stagger: 100,
                duration: 600
            });
        });
    </script>
</body>
</html>
